<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Overlay</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-primary': '#b1d900',   // Pear - Primary accent
            'brand-accent': '#82a000',    // Apple Green - Secondary accent
            'brand-dark': '#5c7000',      // Avocado - Dark variant
            'brand-darker': '#525252',    // Davys Gray - Neutral gray
            'brand-black': '#000000',     // Black - Maximum contrast
          }
        }
      }
    }
  </script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: transparent;
    }

    /* 3-step entrance animation sequence */

    /* Step 1: Border fade-in */
    @keyframes fade-in-border {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Step 2: EN VIVO slide from left */
    @keyframes slide-in-label {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Step 3: SANTIAGO slide from left */
    @keyframes slide-in-text {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* 3-step exit animation sequence (reverse order) */

    /* Step 1: SANTIAGO slide out to left */
    @keyframes slide-out-text {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100%);
        opacity: 0;
      }
    }

    /* Step 2: EN VIVO slide out to left */
    @keyframes slide-out-label {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100%);
        opacity: 0;
      }
    }

    /* Step 3: Border fade-out */
    @keyframes fade-out-border {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Apply entrance animations - Sequential timing */
    .live-container.animate-entrance {
      animation: fade-in-border 0.4s cubic-bezier(0.25, 0.1, 0.25, 1.0) forwards;
    }

    .live-label.animate-entrance {
      animation: slide-in-label 0.5s cubic-bezier(0.25, 0.1, 0.25, 1.0) 0.4s forwards;
    }

    .live-text.animate-entrance {
      animation: slide-in-text 0.5s cubic-bezier(0.25, 0.1, 0.25, 1.0) 0.9s forwards;
    }

    /* Apply exit animations - Same order as entrance (border first) */
    .live-container.animate-exit {
      animation: fade-out-border 0.4s cubic-bezier(0.25, 0.1, 0.25, 1.0) forwards;
    }

    .live-text.animate-exit {
      animation: slide-out-text 0.5s cubic-bezier(0.25, 0.1, 0.25, 1.0) 0.4s forwards;
    }

    .live-label.animate-exit {
      animation: slide-out-label 0.5s cubic-bezier(0.25, 0.1, 0.25, 1.0) 0.4s forwards;
    }

    /* Initial state - hidden */
    .live-container,
    .live-label,
    .live-text {
      opacity: 0;
    }

    /* Layer order */
    .live-label {
      position: relative;
      z-index: 2; /* EN VIVO on top */
    }

    .live-text {
      position: relative;
      z-index: 1; /* SANTIAGO behind EN VIVO */
    }

    /* Smooth transitions */
    .live-transition {
      transition: all 0.7s ease-in-out;
    }
  </style>
</head>
<body>

  <!-- Live Indicator Container -->
  <div id="live-indicator" class="fixed top-32 left-40 hidden">
    <!-- Badge Container -->
    <div class="live-container flex rounded-lg border-2 border-brand-primary overflow-hidden bg-gradient-to-t from-zinc-900 to-black live-transition">

      <!-- "EN VIVO" Label - Dark brand gradient for better contrast -->
      <span class="live-label bg-gradient-to-t from-brand-dark to-brand-accent uppercase text-white px-8 py-2 text-2xl font-semibold whitespace-nowrap">
        EN VIVO
      </span>

      <!-- Location Text - Dark gradient for better contrast -->
      <span id="live-location" class="live-text bg-gradient-to-t from-black to-zinc-900 text-white px-8 py-2 text-2xl whitespace-nowrap" style="font-family: Raleway, sans-serif;">
        SANTIAGO
      </span>

    </div>
  </div>

  <script>
    // State Transition Manager - tracks previous config to detect state changes
    let previousConfig = null

    // Config default
    const DEFAULT_CONFIG = {
      text: 'SANTIAGO',
      isVisible: false,
      aspectRatio: '16:9'
    }

    // Load config from localStorage
    function loadConfig() {
      const saved = localStorage.getItem('obs-live-config')
      if (saved) {
        return JSON.parse(saved)
      }
      return DEFAULT_CONFIG
    }

    // Detect if state actually changed (prevents redundant processing during polling)
    function detectStateChange(prev, curr) {
      if (prev === null) return true // First load
      return prev.isVisible !== curr.isVisible || prev.text !== curr.text || prev.aspectRatio !== curr.aspectRatio
    }

    // Play entrance animation
    function playEntranceAnimation() {
      const liveContainer = document.querySelector('.live-container')
      const liveLabel = document.querySelector('.live-label')
      const liveText = document.querySelector('.live-text')

      // Remove any exit animations
      liveContainer.classList.remove('animate-exit')
      liveLabel.classList.remove('animate-exit')
      liveText.classList.remove('animate-exit')

      // Force reflow
      void liveContainer.offsetWidth

      // Apply entrance animations
      liveContainer.classList.add('animate-entrance')
      liveLabel.classList.add('animate-entrance')
      liveText.classList.add('animate-entrance')
    }

    // Play exit animation
    function playExitAnimation() {
      const liveContainer = document.querySelector('.live-container')
      const liveLabel = document.querySelector('.live-label')
      const liveText = document.querySelector('.live-text')

      // Remove entrance animations
      liveContainer.classList.remove('animate-entrance')
      liveLabel.classList.remove('animate-entrance')
      liveText.classList.remove('animate-entrance')

      // Force reflow
      void liveContainer.offsetWidth

      // Apply exit animations (same order: border first, then content)
      liveContainer.classList.add('animate-exit')
      liveLabel.classList.add('animate-exit')
      liveText.classList.add('animate-exit')

      // Hide container after animation completes (0.9s total: 0.4s border + 0.5s slides)
      setTimeout(() => {
        const container = document.getElementById('live-indicator')
        container.classList.add('hidden')
      }, 900)
    }

    // Apply config to overlay with state transition detection
    function applyConfig(config) {
      const container = document.getElementById('live-indicator')
      const locationText = document.getElementById('live-location')

      // Detect if this is an actual state change
      const isStateChange = detectStateChange(previousConfig, config)

      if (!isStateChange && previousConfig !== null) {
        return // Skip if polling with no change
      }

      // Update position based on aspect ratio
      // 16:9 â†’ left-40 (160px), 4:3 â†’ left-80 (320px)
      const baseClasses = 'fixed top-32'
      if (config.aspectRatio === '4:3') {
        container.className = baseClasses + ' left-80'
      } else {
        container.className = baseClasses + ' left-40'
      }

      // Update location text
      locationText.textContent = config.text || 'SANTIAGO'

      // Detect entrance transition (false â†’ true or initial load)
      const wasHidden = !previousConfig || !previousConfig.isVisible
      const isNowVisible = config.isVisible

      // Show/hide with animations
      if (isNowVisible) {
        container.classList.remove('hidden')
        if (wasHidden) {
          playEntranceAnimation()
        }
      } else {
        if (previousConfig && previousConfig.isVisible) {
          // Was visible, now hiding - play exit animation
          playExitAnimation()
        } else {
          // Already hidden
          container.classList.add('hidden')
        }
      }

      // Store current config as previous for next comparison
      previousConfig = { ...config }

      console.log('ðŸ“º Live overlay updated:', config, 'wasHidden:', wasHidden)
    }

    // Listen for storage changes (when controller updates config)
    window.addEventListener('storage', (e) => {
      if (e.key === 'obs-live-config') {
        const config = loadConfig()
        applyConfig(config)
      }
    })

    // Polling fallback (in case storage event doesn't fire)
    setInterval(() => {
      const config = loadConfig()
      applyConfig(config)
    }, 1000)

    // Apply initial config
    window.addEventListener('DOMContentLoaded', () => {
      const config = loadConfig()
      applyConfig(config)
    })
  </script>
</body>
</html>
